---
import { t } from '@i18n/utils';

interface Props {
  locale: string;
  class?: string;
}

const { locale, class: className } = Astro.props;
const i18n = t(locale);
---

<div class:list={['menu-collapsed', className]}>
  <div class="text-wrapper">
    <div class="text-inner">
      <span>{i18n.menu.contact}</span>
      <span>{i18n.menu.work}</span>
      <span>{i18n.menu.home}</span>
    </div>
  </div>
  <div class="subsection-wrapper">
    <div class="subsection-inner">
      <span>{i18n.work.pages.keyVisuals.title}</span>
      <span>{i18n.work.pages.productPhotography.title}</span>
      <span>{i18n.work.pages.socialMedia.title}</span>
    </div>
  </div>
</div>

<script>
  import { gsap } from 'gsap';

  const el = document.querySelector('.menu-collapsed') as HTMLElement;
  const wrapper = document.querySelector('.menu-wrapper') as HTMLElement;
  if (el && wrapper) {
    const textInner = el.querySelector('.text-inner') as HTMLElement;
    const subWrapper = el.querySelector('.subsection-wrapper') as HTMLElement;
    const subInner = el.querySelector('.subsection-inner') as HTMLElement;

    // Measure actual span height for transform calculations
    const spanHeight = (textInner.querySelector('span') as HTMLElement).offsetHeight;
    const spanCount = textInner.querySelectorAll('span').length;

    // Text y offsets: stack is reversed (contact, work, home top-to-bottom)
    // home = -(spanCount-1)*spanHeight, work = -spanHeight, contact = 0
    const TEXT_Y_HOME = -(spanCount - 1) * spanHeight;
    const TEXT_Y_WORK = -spanHeight;
    const TEXT_Y_CONTACT = 0;

    // Work width: responsive
    const workWidth = window.innerWidth <= 596
      ? window.innerWidth - 56
      : 540;
    const defaultWidth = 148;

    // GSAP easing (spring-like approximations)
    const EASE_SMOOTH = 'power3.out';
    const EASE_SNAPPY = 'back.out(1.7)';
    const DUR_SMOOTH = 0.5;
    const DUR_SNAPPY = 0.35;
    const DUR_FADE = 0.3;

    // Set initial state: home (hidden via wrapper opacity)
    gsap.set(textInner, { y: TEXT_Y_HOME });
    gsap.set(subInner, { opacity: 0, visibility: 'hidden' });
    gsap.set(subWrapper, { maxWidth: 0 });

    let currentType = 'intro';
    let currentPage = -1;

    interface MenuStateDetail {
      type: 'intro' | 'work' | 'contact';
      page?: number;
    }

    window.addEventListener('menu:state', ((e: CustomEvent<MenuStateDetail>) => {
      const { type, page } = e.detail;

      // Skip if nothing changed
      if (type === currentType && (type !== 'work' || page === currentPage)) return;

      const prevType = currentType;
      currentType = type;
      currentPage = page ?? -1;

      // --- Show / hide wrapper ---
      if (type === 'intro') {
        gsap.to(wrapper, {
          opacity: 0,
          duration: DUR_FADE,
          ease: EASE_SMOOTH,
          onComplete: () => { wrapper.style.pointerEvents = 'none'; },
        });
        return;
      }

      if (prevType === 'intro') {
        wrapper.style.pointerEvents = 'auto';
        gsap.to(wrapper, { opacity: 1, duration: DUR_FADE, ease: EASE_SMOOTH });
      }

      // --- Work state ---
      if (type === 'work' && page != null) {
        // Subsection y: page 0 → bottom span, page N → top span
        const subSpanCount = subInner.querySelectorAll('span').length;
        const subY = -(subSpanCount - 1 - page) * spanHeight;

        gsap.to(el, { width: workWidth, duration: DUR_SMOOTH, ease: EASE_SMOOTH });
        gsap.to(textInner, { y: TEXT_Y_WORK, duration: DUR_SNAPPY, ease: EASE_SNAPPY });
        gsap.to(subWrapper, { maxWidth: 280, duration: DUR_SMOOTH, ease: EASE_SMOOTH });
        gsap.to(subInner, {
          y: subY,
          opacity: 1,
          visibility: 'visible',
          duration: DUR_SNAPPY,
          ease: EASE_SNAPPY,
        });
        return;
      }

      // --- Contact state (future: outro) ---
      if (type === 'contact') {
        gsap.to(el, { width: defaultWidth, duration: DUR_SMOOTH, ease: EASE_SMOOTH });
        gsap.to(textInner, { y: TEXT_Y_CONTACT, duration: DUR_SNAPPY, ease: EASE_SNAPPY });
        gsap.to(subWrapper, { maxWidth: 0, duration: DUR_SMOOTH, ease: EASE_SMOOTH });
        gsap.to(subInner, { opacity: 0, duration: DUR_FADE, ease: EASE_SMOOTH });
      }
    }) as EventListener);
  }
</script>

<style>
  .menu-collapsed {
    display: inline-flex;
    align-items: center;
    background: var(--color-white);
    border-radius: 100px;
    padding: 32px 42px;
    cursor: pointer;
    width: 148px;
  }

  .text-wrapper,
  .subsection-wrapper {
    overflow: hidden;
  }

  .text-wrapper {
    height: 20px;
  }

  .subsection-wrapper {
    height: 20px;
    max-width: 0;
    margin-left: auto;
  }

  .text-inner span,
  .subsection-inner span {
    display: block;
    font-family: var(--font-body);
    font-size: 16px;
    font-weight: 500;
    line-height: 20px;
    color: var(--color-black);
    white-space: nowrap;
  }

  .subsection-inner {
    padding-left: 16px;
  }
</style>
