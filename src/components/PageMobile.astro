---
import { Image } from 'astro:assets';
import type { HTMLAttributes } from 'astro/types';
import type { ImageMetadata } from 'astro';

interface Props extends HTMLAttributes<'div'> {
  imageSrc: ImageMetadata;
  imageAlt: string;
  galleryId: string;
  mobileImageSrc?: ImageMetadata;
  loading?: 'eager' | 'lazy';
  class?: string;
}

const { imageSrc, imageAlt, galleryId, mobileImageSrc, loading = 'lazy', class: className, ...attrs } = Astro.props;
---

<div class:list={['page-mobile', className]} data-gallery-id={galleryId} role="button" tabindex="0" aria-label={`Open ${imageAlt} gallery`} {...attrs}>
  <Image
    src={imageSrc}
    alt={imageAlt}
    width={1920}
    height={1080}
    format="webp"
    loading={loading}
    class="img-default"
  />
  {mobileImageSrc && (
    <Image
      src={mobileImageSrc}
      alt={imageAlt}
      width={mobileImageSrc.width}
      height={mobileImageSrc.height}
      format="webp"
      loading={loading}
      class="img-small"
    />
  )}
</div>

<script>
  document.querySelectorAll<HTMLElement>('.page-mobile[data-gallery-id]').forEach((page) => {
    const galleryId = page.dataset.galleryId;
    if (!galleryId) return;

    function isPageVisible(): boolean {
      const style = getComputedStyle(page);
      if (style.display === 'none' || style.visibility === 'hidden') return false;
      const section = page.closest('.page-scroll-mobile');
      if (section) {
        const sectionStyle = getComputedStyle(section);
        if (sectionStyle.display === 'none' || sectionStyle.visibility === 'hidden') return false;
      }
      return true;
    }

    page.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!isPageVisible()) return;
      window.dispatchEvent(
        new CustomEvent('gallery:open', { detail: { galleryId } }),
      );
    });

    page.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        e.stopPropagation();
        if (!isPageVisible()) return;
        window.dispatchEvent(
          new CustomEvent('gallery:open', { detail: { galleryId } }),
        );
      }
    });
  });
</script>

<style>
  .page-mobile {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    cursor: pointer;
  }

  .page-mobile::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.1);
    z-index: 1;
    pointer-events: none;
  }

  .page-mobile :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .page-mobile :global(.img-small) {
    display: none;
  }

  @media (max-width: 389px) {
    .page-mobile :global(.img-default) {
      display: none;
    }
    .page-mobile :global(.img-small) {
      display: block;
    }
  }
</style>
